{
  "variables": {
    "base_image_name": "chefdk",
    "base_image_tag": "0.13.21-1",

    "dest_repository": "gsebast:5000",
    "src_repository": "gsebast:5000",

    "prepare_app": "{{env `PREPARE_APP`}}",
    "prepare_app_version": "{{env `PREPARE_APP_VERSION`}}",

    "image_name": "chefdata_{{user `prepare_app`}}-{{user `prepare_app_version`}}",
    "image_tag": "0.1"
  },

  "builders": [
    {
      "type": "docker",
      "image": "{{if {{user `src_repository`}}}}{{user `src_repository`}}/{{end}}{{user `base_image_name`}}:{{user `base_image_tag`}}",
      "commit": true,
      "run_command": [
        "-d",
        "-i",
        "-t",
        "{{.Image}}",
        "/bin/bash"
      ]
    }
  ],

  "provisioners":
  [
    {
      "type": "file",
      "source": "./dockerize/cm/chef/solo.rb",
      "destination": "/tmp/chef/solo.rb"
    },
    {
      "type": "file",
      "source": "./dockerize/cm/berkshelf/",
      "destination": "/tmp/berkshelf/"
    },
    {
      "type": "file",
      "source": "./dockerize/app/jenkins/",
      "destination": "/tmp/berkshelf/"
    },
    {
      "type": "shell",
      "inline": ["berks vendor /tmp/chef/cookbooks -b /tmp/berkshelf/Berksfile --only='2.0-1.1' -c /tmp/berkshelf/config.json"]
    }
  ],

  "post-processors":
  [
    [
      {
        "type": "docker-tag",
        "repository": "{{user `dest_repository`}}/{{user `image_name`}}",
        "tag": "{{user `image_tag`}}"
      },
      {
        "type": "docker-push"
      }
    ]
  ]
}
